<head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <script src="two.js"></script>
</head>
<body></body>
<script>
    let two = new Two({
        fullscreen: true,
        autostart: true
    }).appendTo(document.body);

    const gameData = {
        up: 'w',
        down: 's',
        left: 'a',
        right: 'd',
        intervalLength: 20,
        borderOffset: 150, // 125
        borderWidth: 150, // 150
        frictionCoefficient: 0.9
    }
    
    const playerData = {
        vx: 0,
        vy: 0,
        x: two.width / 2,
        y: two.height / 2,
        width: 50,
        height: 50,
        speed: 1,
        borderCollision: false,
    }

    function collisionController(element, elementData){
        let isColliding = checkCollision(element, [borderLeft, borderRight, borderTop, borderBottom])[0];
        let collider = checkCollision(element, [borderLeft, borderRight, borderTop, borderBottom])[1];


        if(isColliding && !elementData.borderCollision){
            if(collider == 'borderLeft'){
                elementData.x = (two.width - borderLeft.translation._x) - (elementData.width / 2) - (gameData.borderWidth / 2);
                elementData.borderCollision = true;
            }
            if(collider == 'borderRight'){
                elementData.x = (elementData.width / 2) + (gameData.borderWidth / 2) + borderLeft.translation._x;
                elementData.borderCollision = true;
            }
            if(collider == 'borderTop'){
                elementData.y = (two.height - borderTop.translation._y) - (elementData.height / 2)  - (gameData.borderWidth / 2);
                elementData.borderCollision = true;
            }
            if(collider == 'borderBottom'){
                elementData.y = (elementData.height / 2) + (gameData.borderWidth / 2) + borderTop.translation._y;
                elementData.borderCollision = true;
            }
        }
    }
    
    let player = two.makeRectangle(two.width / 2, two.height / 2, 50 ,50);
    player.id = 'player';
    player.fill = 'red';
    player.stroke = 'red';

    let borderLeft = two.makeRectangle(-gameData.borderOffset, 0, gameData.borderWidth, two.height * 2);
    let borderRight = two.makeRectangle(two.width + gameData.borderOffset, 0, gameData.borderWidth, two.height * 2);
    let borderTop = two.makeRectangle(0, -gameData.borderOffset, two.width * 2, gameData.borderWidth);
    let borderBottom = two.makeRectangle(0, two.height + gameData.borderOffset, two.width * 2, gameData.borderWidth);

    // make a border for the screen
    let screenLeft = two.makeRectangle(-gameData.borderOffset + 123, 0, 2, two.height * 2);
    let screenRight = two.makeRectangle(two.width + gameData.borderOffset - 123, 0, 2, two.height * 2);
    let screenTop = two.makeRectangle(0, -gameData.borderOffset + 123, two.width * 2, 2);
    let screenBottom = two.makeRectangle(0, two.height + gameData.borderOffset - 123, two.width * 2, 2);

    borderLeft.id = 'borderLeft'
    borderRight.id = 'borderRight'
    borderTop.id = 'borderTop'
    borderBottom.id = 'borderBottom'

    screenLeft.id = 'screenLeft'
    screenRight.id = 'screenRight'
    screenTop.id = 'screenTop'
    screenBottom.id = 'screenBottom'

    borderLeft.fill = 'blue'
    borderRight.fill = 'blue'
    borderTop.fill = 'blue'
    borderBottom.fill = 'blue'

    screenLeft.fill = 'black'
    screenRight.fill = 'black'
    screenTop.fill = 'black'
    screenBottom.fill = 'black'

    window.onresize = () => {
        borderRight.translation.x = two.width + gameData.borderOffset;
        borderRight.height = two.height * 2;

        borderBottom.translation.y = two.height + gameData.borderOffset;
        borderBottom.width = two.width * 2;

        borderTop.width = two.width * 2;

        borderLeft.height = two.height * 2;

        playerData.x = two.width / 2;
        playerData.y = two.height / 2;
    }

    function checkCollision(rect, colliders){
        let collision = false;
        let collider = undefined;
        for(i = 0; i < colliders.length; i++){
            let rectMinX = rect.translation._x - rect.width / 2;
            let rectMaxX = rect.translation._x + rect.width / 2;
            let rectMinY = rect.translation._y - rect.height / 2;
            let rectMaxY = rect.translation._y + rect.height / 2;

            let colliderMinX = colliders[i].translation._x - colliders[i].width / 2;
            let colliderMaxX = colliders[i].translation._x + colliders[i].width / 2;
            let colliderMinY = colliders[i].translation._y - colliders[i].height / 2;
            let colliderMaxY = colliders[i].translation._y + colliders[i].height / 2;

            if(rectMinX < colliderMaxX && rectMaxX > colliderMinX && rectMinY < colliderMaxY && rectMaxY > colliderMinY){
                collider = colliders[i].id;
                collision = true;
                break;
            }
        }
        return [collision, collider];
    }

    function movePlayer(x, y){

        playerData.x += x;
        playerData.y += y;

        player.translation._x += playerData.x;
        player.translation._y += playerData.y;
        

        player.translation.set(playerData.x, playerData.y);
    }




    function playerController(){
        const keys = {};

        document.onkeydown = e => {
            keys[e.key] = true;
        };

        document.onkeyup = e => {
            keys[e.key] = false;
        };

        function move(){
            collisionController(player, playerData)
            if(keys[gameData.up]){
                playerData.vy -= playerData.speed;
                playerData.borderCollision = false;
            }
            if(keys[gameData.down]){
                playerData.vy += playerData.speed;
                playerData.borderCollision = false;
            }
            if(keys[gameData.left]){
                playerData.vx -= playerData.speed;
                playerData.borderCollision = false;
            }
            if(keys[gameData.right]){
                playerData.vx += playerData.speed;   
                playerData.borderCollision = false;  
            }

            
            playerData.vx *= gameData.frictionCoefficient;
            playerData.vy *= gameData.frictionCoefficient;
            
            movePlayer(playerData.vx, playerData.vy);
        }
        setInterval(move, gameData.intervalLength);
    }

    playerController()


    // npm start
    // electron-packager ./ JS-Game --platform=win32 --arch=ia32 ./JS-Game
</script>